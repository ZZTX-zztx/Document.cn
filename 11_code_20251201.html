<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ‰‹æœº Edge æ‰©éŸ³å™¨ï¼ˆHTTPS ä¸“ç”¨ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f5f5f5; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        .wrap { max-width: 400px; margin: 0 auto; background: #fff; border-radius: 16px; padding: 30px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .title { font-size: 1.6rem; color: #333; text-align: center; margin-bottom: 30px; }
        .mic { font-size: 4rem; text-align: center; color: #2196F3; margin-bottom: 30px; transition: all 0.3s; }
        .mic.active { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #1976D2; }
            100% { transform: scale(1); }
        }
        .btn { width: 100%; padding: 16px; background: #F44336; color: #fff; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; margin-bottom: 25px; }
        .btn.on { background: #4CAF50; }
        .volume { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .volume span { font-size: 1rem; color: #666; }
        .volume input { flex: 1; height: 8px; -webkit-appearance: none; background: #eee; border-radius: 4px; }
        .volume input::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: #2196F3; }
        .mode-group { margin: 20px 0; text-align: center; }
        .mode-group span { color: #666; font-size: 1rem; margin-right: 10px; }
        .mode-group select { padding: 8px; border-radius: 6px; border: 1px solid #eee; font-size: 0.9rem; }
        .tip { font-size: 0.9rem; color: #999; text-align: center; line-height: 1.5; }
        .permission-tip { font-size: 0.85rem; color: #FF9800; text-align: center; margin: 10px 0; display: none; }
    </style>
</head>
<body>
    <div class="wrap">
        <h2 class="title">ğŸ”Š æ‰‹æœºå®æ—¶æ‰©éŸ³å™¨</h2>
        <div class="mic" id="micIcon">ğŸ¤</div>
        <button class="btn" id="btn">å¼€å¯æ‰©éŸ³</button>
        
        <div class="volume">
            <span>éŸ³é‡</span>
            <input type="range" id="vol" min="0" max="200" value="100" disabled>
            <span id="volNum">100%</span>
        </div>
        
        <div class="mode-group">
            <span>æ‰©éŸ³æ¨¡å¼ï¼š</span>
            <select id="mode" disabled>
                <option value="normal">æ™®é€šæ¨¡å¼</option>
                <option value="loud">å¤§å£°æ¨¡å¼</option>
                <option value="clear">æ¸…æ™°æ¨¡å¼</option>
            </select>
        </div>
        
        <div class="tip" id="tip">ç‚¹å‡»æŒ‰é’®ï¼Œå°†è‡ªåŠ¨è¯·æ±‚éº¦å…‹é£æƒé™</div>
        <div class="permission-tip" id="permissionTip">âš ï¸ è¯·åœ¨ Edge å¼¹çª—ä¸­é€‰æ‹©ã€Œå…è®¸ã€éº¦å…‹é£æƒé™</div>
    </div>

    <script>
        // æ ¸å¿ƒå˜é‡ï¼ˆæç®€å‘½åï¼‰
        let aCtx, src, gain, stream;
        const btn = document.getElementById('btn');
        const vol = document.getElementById('vol');
        const volNum = document.getElementById('volNum');
        const tip = document.getElementById('tip');
        const micIcon = document.getElementById('micIcon');
        const mode = document.getElementById('mode');
        const permissionTip = document.getElementById('permissionTip');
        let on = false;

        // HTTPS ç¯å¢ƒä¸“ç”¨å…¼å®¹é…ç½®
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const getUserMedia = navigator.mediaDevices.getUserMedia || 
                            function(constraints) {
                                return new Promise((resolve, reject) => {
                                    const gum = navigator.getUserMedia || navigator.webkitGetUserMedia;
                                    if (gum) gum.call(navigator, constraints, resolve, reject);
                                    else reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£'));
                                });
                            };

        // å¼ºåˆ¶è§¦å‘æƒé™è¯·æ±‚ï¼ˆHTTPS ç¯å¢ƒä¼˜åŒ–ï¼‰
        const requestMic = async () => {
            try {
                // 1. æ˜¾ç¤ºæˆæƒæç¤ºï¼Œå¼•å¯¼ç”¨æˆ·æ“ä½œ
                permissionTip.style.display = 'block';
                // 2. ç®€åŒ–éº¦å…‹é£çº¦æŸï¼Œç¡®ä¿ Edge è¯†åˆ«
                const constraints = { 
                    audio: { 
                        echoCancellation: false,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                };
                // 3. å¼ºåˆ¶è¯·æ±‚éº¦å…‹é£ï¼ˆHTTPS ç¯å¢ƒä¸‹ä¼˜å…ˆè°ƒç”¨ï¼‰
                stream = await getUserMedia(constraints);
                // 4. åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆä¸¥æ ¼åœ¨ç”¨æˆ·ç‚¹å‡»å†…è§¦å‘ï¼‰
                aCtx = new AudioContext();
                src = aCtx.createMediaStreamSource(stream);
                gain = aCtx.createGain();
                // 5. éŸ³é¢‘é“¾è·¯ï¼ˆæç®€è¿æ¥ï¼‰
                src.connect(gain);
                gain.connect(aCtx.destination);
                gain.gain.value = vol.value / 100;
                return true;
            } catch (e) {
                // æƒé™è¯·æ±‚å¤±è´¥ï¼ˆæ˜ç¡®æç¤ºåŸå› ï¼‰
                tip.textContent = 'æƒé™è¯·æ±‚å¤±è´¥ï¼š' + e.message;
                tip.style.color = '#F44336';
                permissionTip.style.display = 'none';
                return false;
            }
        };

        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆå”¯ä¸€è§¦å‘å…¥å£ï¼Œç¡®ä¿ç”¨æˆ·ä¸»åŠ¨æ“ä½œï¼‰
        btn.addEventListener('click', async () => {
            if (!on) {
                // å¼€å¯æµç¨‹
                btn.disabled = true;
                tip.textContent = 'æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';
                tip.style.color = '#FF9800';
                // å¼ºåˆ¶è¯·æ±‚éº¦å…‹é£
                const success = await requestMic();
                if (success) {
                    // è¯·æ±‚æˆåŠŸï¼šæ¿€æ´»æ‰€æœ‰åŠŸèƒ½
                    on = true;
                    btn.textContent = 'å…³é—­æ‰©éŸ³';
                    btn.classList.add('on');
                    micIcon.classList.add('active');
                    vol.disabled = false;
                    mode.disabled = false;
                    tip.textContent = 'æ‰©éŸ³ä¸­ï¼å¯¹ç€éº¦å…‹é£è¯´è¯';
                    tip.style.color = '#4CAF50';
                    permissionTip.style.display = 'none';
                }
                btn.disabled = false;
            } else {
                // å…³é—­æµç¨‹
                stream.getTracks().forEach(t => t.stop());
                aCtx.close();
                on = false;
                btn.textContent = 'å¼€å¯æ‰©éŸ³';
                btn.classList.remove('on');
                micIcon.classList.remove('active');
                vol.disabled = true;
                mode.disabled = true;
                tip.textContent = 'ç‚¹å‡»æŒ‰é’®ï¼Œå°†è‡ªåŠ¨è¯·æ±‚éº¦å…‹é£æƒé™';
                tip.style.color = '#999';
                permissionTip.style.display = 'none';
            }
        });

        // éŸ³é‡è°ƒèŠ‚ï¼ˆå®æ—¶åŒæ­¥ï¼‰
        vol.addEventListener('input', () => {
            const value = vol.value;
            volNum.textContent = value + '%';
            if (gain) gain.gain.value = value / 100;
        });

        // æ¨¡å¼åˆ‡æ¢ï¼ˆé€‚é…ä¸åŒåœºæ™¯ï¼‰
        mode.addEventListener('change', () => {
            if (!gain) return;
            switch(mode.value) {
                case 'loud':
                    gain.gain.value = 2.0;
                    vol.value = 200;
                    volNum.textContent = '200%';
                    break;
                case 'clear':
                    gain.gain.value = 1.2;
                    vol.value = 120;
                    volNum.textContent = '120%';
                    break;
                default:
                    gain.gain.value = 1.0;
                    vol.value = 100;
                    volNum.textContent = '100%';
            }
        });

        // HTTPS ç¯å¢ƒåˆå§‹åŒ–æ£€æµ‹ï¼ˆç¡®ä¿é¡µé¢åŠ è½½æ­£å¸¸ï¼‰
        window.addEventListener('load', () => {
            if (window.location.protocol !== 'https:') {
                tip.textContent = 'å½“å‰é HTTPS ç¯å¢ƒï¼Œæ— æ³•è¯·æ±‚éº¦å…‹é£';
                tip.style.color = '#F44336';
                btn.disabled = true;
            }
        });
    </script>
</body>
</html>
